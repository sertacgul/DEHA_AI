<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DEHA AI">
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/240/artificial-intelligence.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/artificial-intelligence.png">
    
    <link rel="manifest" href="manifest.json">

    <title>DEHA AI v17.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';</script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
            /* iOS Alt √áizgi ve √úst √áentik Korumasƒ± */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            height: 100vh;
            overflow: hidden; 
            -webkit-user-select: none; /* Mobilde metin se√ßimini engelle (app hissi i√ßin) */
            user-select: none;
        }
        
        /* App Like Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 5px; }

        .glass-panel { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .highlight-text { background-color: #facc15; color: #000; font-weight: bold; padding: 0 2px; border-radius: 2px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .flashcard-container { transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .flashcard-container.flipped { transform: rotateY(180deg); }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }
        
        #diagram-container { display: block; width: 100%; height: 100%; padding: 20px; overflow: auto; -webkit-overflow-scrolling: touch; }
        .mermaid { background-color: #f8fafc; padding: 20px; border-radius: 8px; min-width: 2000px; box-shadow: 0 0 50px rgba(0,0,0,0.5); display: flex; justify-content: center; }
        .mermaid svg { max-width: none !important; font-family: 'Inter', sans-serif !important; }
        .node rect, .node circle, .node polygon { stroke-width: 3px !important; }
        .nodeLabel { font-size: 24px !important; font-weight: bold !important; }
        .edgeLabel { font-size: 18px !important; background-color: white !important; padding: 4px; }
        button { touch-action: manipulation; }
        /* Se√ßilebilir metin alanlarƒ± (Inputlar hari√ß se√ßim kapalƒ±ydƒ±) */
        #simple-viewer-content, #user-input, .selectable { -webkit-user-select: text; user-select: text; }
    </style>
</head>
<body class="flex flex-col relative">

    <header class="h-14 border-b border-slate-700 bg-slate-900 flex items-center justify-between px-4 z-20 shadow-lg flex-shrink-0">
        <div class="flex items-center gap-3">
            <button id="history-toggle-btn" class="text-slate-300 hover:text-white p-2 rounded-md transition"><i class="fa-solid fa-bars text-xl"></i></button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/50"><i class="fa-solid fa-brain text-white text-sm"></i></div>
                <h1 class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 tracking-wide">DEHA</h1>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="save-api-key-btn" class="bg-slate-800 text-slate-300 p-2 rounded border border-slate-600 text-xs" title="API Key"><i class="fa-solid fa-key"></i></button>
            <input type="password" id="api-key-input" class="hidden bg-slate-800 border border-slate-600 text-white text-xs rounded p-2 absolute right-14 top-14 w-48 z-50 shadow-xl" placeholder="API Key Gir ve Enter'a bas">
            <label for="file-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 flex items-center justify-center rounded-md transition shadow-lg shadow-blue-500/30"><i class="fa-solid fa-plus"></i></label>
            <input type="file" id="file-upload" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.png" class="hidden">
        </div>
    </header>

    <div id="history-sidebar" class="absolute top-14 left-0 bottom-0 w-72 bg-slate-900 border-r border-slate-700 z-30 sidebar sidebar-closed flex flex-col shadow-2xl">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900">
            <h2 class="text-sm font-bold text-slate-200 uppercase">Ge√ßmi≈ü</h2>
            <button id="close-history-btn" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2"><p class="text-xs text-slate-600 text-center mt-4">Ge√ßmi≈ü yok</p></div>
    </div>

    <div class="flex-1 flex overflow-hidden relative z-10 flex-col md:flex-row">
        <div class="hidden md:flex w-1/2 flex-col border-r border-slate-700 relative">
            <div class="flex-1 relative bg-slate-900 overflow-hidden group cursor-default">
                <canvas id="knowledge-graph" class="absolute inset-0 w-full h-full"></canvas>
                <div id="doc-list-overlay" class="absolute bottom-4 left-4 right-4 max-h-60 overflow-y-auto glass-panel rounded-lg p-3 opacity-90 z-20">
                    <ul id="file-list" class="space-y-1 text-sm text-slate-400"><li class="italic text-slate-600 text-xs">Dosya y√ºklenmedi...</li></ul>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/2 flex flex-col bg-slate-950 relative h-full">
            
            <div id="flashcard-overlay" class="absolute inset-0 bg-slate-900/95 z-50 flex flex-col items-center justify-center p-4 hidden backdrop-blur-sm">
                <button id="close-flashcards-btn" class="absolute top-4 right-4 text-white p-2"><i class="fa-solid fa-xmark text-2xl"></i></button>
                <div class="perspective-1000 w-full max-w-sm h-64">
                    <div id="flashcard-inner" class="flashcard-container relative w-full h-full bg-slate-800 rounded-xl shadow-2xl border border-slate-600" onclick="this.classList.toggle('flipped')">
                        <div class="absolute inset-0 w-full h-full backface-hidden flex items-center justify-center p-6 text-center bg-slate-800 rounded-xl"><div><p class="text-xs text-slate-500 mb-2">Soru</p><h3 id="fc-front" class="text-xl font-bold text-white">...</h3></div></div>
                        <div class="absolute inset-0 w-full h-full backface-hidden rotate-y-180 flex items-center justify-center p-6 text-center bg-slate-900 rounded-xl border border-cyan-500"><div><p class="text-xs text-cyan-400 mb-2">Cevap</p><p id="fc-back" class="text-md text-slate-200 selectable">...</p></div></div>
                    </div>
                </div>
                <div class="flex gap-6 mt-8">
                    <button id="prev-fc" class="bg-slate-700 text-white rounded-full w-12 h-12"><i class="fa-solid fa-arrow-left"></i></button>
                    <button id="next-fc" class="bg-slate-700 text-white rounded-full w-12 h-12"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>

            <div id="diagram-modal" onclick="if(event.target.id === 'diagram-modal') this.classList.add('hidden')" class="fixed inset-0 bg-slate-950/98 z-50 hidden overflow-auto cursor-pointer">
                <div class="absolute top-4 right-4 text-slate-500 text-sm bg-slate-900 px-3 py-1 rounded border border-slate-700 pointer-events-none z-50">Kapatmak i√ßin tƒ±kla</div>
                <div id="diagram-container"><div id="mermaid-output" class="pointer-events-none"></div></div>
            </div>

            <div id="page-viewer-overlay" class="absolute inset-0 bg-slate-950 z-50 flex flex-col hidden">
                <div class="flex justify-between p-4 bg-slate-900 border-b border-slate-700"><h3 class="text-white font-bold">G√∂r√ºnt√ºleyici</h3><button id="close-viewer-btn" class="text-white"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                <div class="flex-1 overflow-auto p-4 flex justify-center bg-slate-900" id="viewer-body"><div class="relative shadow-2xl"><canvas id="page-viewer-canvas"></canvas><div id="simple-viewer-content" class="hidden text-slate-300 p-4 font-mono text-xs whitespace-pre-wrap selectable"></div></div></div>
            </div>

            <div id="ocr-modal" class="absolute inset-0 bg-slate-900/90 z-50 hidden flex items-center justify-center"><div class="bg-slate-800 p-6 rounded-xl border border-slate-600 shadow-2xl"><h3 class="text-indigo-400 font-bold mb-2">OCR ƒ∞≈üleniyor...</h3><div class="w-64 bg-slate-700 h-2 rounded-full"><div id="ocr-progress" class="bg-indigo-500 h-2 rounded-full" style="width:0%"></div></div></div></div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
                <div class="flex gap-4"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-robot text-white text-xs"></i></div><div class="glass-panel p-4 rounded-r-xl rounded-bl-xl text-slate-300 text-sm">Merhaba! DEHA v17.9 iOS Hazƒ±r. <br>App olarak kullanmak i√ßin "Ana Ekrana Ekle" diyebilirsin.</div></div>
            </div>

            <div class="p-3 bg-slate-900 border-t border-slate-700 flex-shrink-0 safe-area-pb">
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button id="start-quiz-btn" class="bg-yellow-600 hover:bg-yellow-500 text-white text-[10px] py-2 rounded font-bold flex flex-col items-center transition shadow-md"><i class="fa-solid fa-clipboard-question mb-1 text-sm"></i>Quiz</button>
                    <button id="prepare-cards-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white text-[10px] py-2 rounded font-bold flex flex-col items-center transition shadow-md"><i class="fa-solid fa-layer-group mb-1 text-sm"></i>Kart</button>
                    <button id="diagram-btn" class="bg-orange-600 hover:bg-orange-500 text-white text-[10px] py-2 rounded font-bold flex flex-col items-center transition shadow-md"><i class="fa-solid fa-sitemap mb-1 text-sm"></i>≈ûema</button>
                    <button id="podcast-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] py-2 rounded font-bold flex flex-col items-center transition shadow-md"><i class="fa-solid fa-microphone-lines mb-1 text-sm"></i>Pod</button>
                </div>
                <div class="relative flex gap-2">
                    <input type="text" id="user-input" placeholder="Dok√ºmanlarda ara veya sor..." class="w-full bg-slate-800 text-white rounded-lg pl-4 pr-4 py-3 border border-slate-600 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all shadow-inner">
                    <button id="send-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 transition shadow-lg shadow-indigo-500/30"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
                <div class="hidden">
                    <button id="concepts-btn"></button><button id="critique-btn"></button><button id="suggest-btn"></button>
                    <button id="explain-selection-btn"></button><button id="read-selection-btn"></button>
                    <button id="btn-saved-quiz"></button><button id="btn-saved-cards"></button>
                    <input type="checkbox" id="ai-mode-toggle" checked>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        mermaid.initialize({ startOnLoad: false, theme: 'base', securityLevel: 'loose', flowchart: { useMaxWidth: false, htmlLabels: true }, themeVariables: { fontSize: '32px', fontFamily: 'Inter', nodeBorder: '3px', clusterBorders: '3px', lineColor: '#334155', mainBkg: '#ffffff', nodeBkg: '#ffffff' } });
        
        let appW=0,appH=0;
        const state = { documents: [], nodes: [], quizHistory: [], flashcardHistory: [], chatHistory: [], viewer: {docId:null, pageNum:1}, aiMode: true };

        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiIconBtn = document.querySelector('#save-api-key-btn');
        const fileInput = document.getElementById('file-upload');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        
        // --- API Key Toggle ---
        saveApiIconBtn.onclick = () => {
            apiKeyInput.classList.toggle('hidden');
            if(!apiKeyInput.classList.contains('hidden')) apiKeyInput.focus();
        };
        apiKeyInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                if(apiKeyInput.value.trim()) { localStorage.setItem('deha_api_key', apiKeyInput.value.trim()); apiKeyInput.classList.add('hidden'); alert("Anahtar Kaydedildi"); }
            }
        });

        // --- Simplified JS Functions ---
        function addMessage(msg, sender, isHtml=false) {
            const div = document.createElement('div');
            div.className = `flex gap-4 ${sender==='user'?'flex-row-reverse':''} animate-fade-in`;
            div.innerHTML = `<div class="${sender==='user'?'bg-slate-800 rounded-l-xl rounded-br-xl':'glass-panel rounded-r-xl rounded-bl-xl'} p-3 border border-slate-700 max-w-[85%] text-sm text-slate-300 shadow-sm">${isHtml?msg:`<p>${msg}</p>`}</div>`;
            chatContainer.appendChild(div); chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        function addLoader(txt) {
            const id='l-'+Date.now(); const div=document.createElement('div'); div.id=id; div.className='flex gap-4';
            div.innerHTML=`<div class="glass-panel p-3 rounded-xl flex items-center gap-2 border border-slate-700"><div class="loader"></div><span class="text-xs text-indigo-300 animate-pulse">${txt}</span></div>`;
            chatContainer.appendChild(div); chatContainer.scrollTop=chatContainer.scrollHeight; return id;
        }
        function removeLoader(id){ const el=document.getElementById(id); if(el) el.remove(); }

        async function callGemini(prompt) {
            const key = localStorage.getItem('deha_api_key');
            if(!key) { addMessage("L√ºtfen √∂nce API Anahtarƒ± girin (Anahtar simgesi).", 'bot'); return null; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json(); return data.candidates[0].content.parts[0].text;
            } catch(e) { console.error(e); addMessage("API Hatasƒ±. Anahtarƒ±nƒ±zƒ± kontrol edin.", 'bot'); return null; }
        }

        function sanitizeMermaidCode(code) {
            let clean = code.replace(/```mermaid/g, '').replace(/```/g, '').trim();
            clean = clean.replace(/^[\d]+\.\s*/gm, '').replace(/^[\-\*]\s*/gm, '').replace(/\[([^"\]]*?[\(\)][^"\]]*?)\]/g, '["$1"]');
            return clean;
        }

        // --- Core Logic ---
        window.generateDiagram = async (id) => {
            const doc = state.documents.find(d=>d.id===id); if(!doc) return;
            document.getElementById('diagram-modal').classList.remove('hidden');
            const output = document.getElementById('mermaid-output'); output.innerHTML='<div class="text-orange-500 animate-pulse text-center mt-20 font-bold text-lg">Diyagram Hesaplanƒ±yor...</div>';
            const res = await callGemini(`Create a comprehensive Mermaid.js diagram. Use 'graph LR'. Node IDs must be alphanumeric ONLY. Wrap ALL labels in double quotes. No cylinder shapes. Output ONLY code. Text: ${doc.fullText.substring(0,10000)}`);
            if(res) {
                try {
                    const clean = sanitizeMermaidCode(res); const uid='d-'+Date.now();
                    output.innerHTML=`<pre class="mermaid" id="${uid}">${clean}</pre>`;
                    await mermaid.run({nodes:[document.getElementById(uid)]});
                } catch(e) { output.innerHTML="Hata: "+e.message; }
            } else { output.innerHTML="Baƒülantƒ± hatasƒ±"; }
        };

        window.generatePodcast = async (id) => {
            const doc = state.documents.find(d=>d.id===id); if(!doc) return;
            const l = addLoader("Podcast senaryosu...");
            const res = await callGemini(`Convert key info to podcast script. Labels: 'Sunucu:' and 'Uzman:'. **Output in same language as text.** Text: ${doc.fullText.substring(0,10000)}`);
            removeLoader(l);
            if(res) {
                let html = `<div class="bg-slate-800/80 p-3 rounded border border-indigo-500/30 mt-2"><div class="flex justify-between items-center mb-2"><div class="text-indigo-300 text-xs font-bold">üéôÔ∏è Podcast</div></div><div class="text-xs text-slate-300 leading-relaxed space-y-2 whitespace-pre-line">${res.replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-100">$1</strong>')}</div><div class="mt-2 text-right"><button onclick="window.playPodcast(this.parentElement.previousElementSibling.innerText)" class="text-[10px] bg-indigo-500 text-white px-3 py-1.5 rounded flex items-center gap-1 inline-flex"><i class="fa-solid fa-play"></i> Seslendir</button></div></div>`;
                addMessage(html, 'bot', true);
            }
        };

        window.playPodcast = function(scriptText) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const lines = scriptText.split('\n').filter(line => line.trim() !== '');
                const voices = window.speechSynthesis.getVoices();
                // T√ºrk√ße sesi zorlamaya √ßalƒ±≈üalƒ±m
                const trVoices = voices.filter(v => v.lang.includes('tr'));
                const hostVoice = trVoices[0] || voices[0];
                const expertVoice = trVoices[1] || trVoices[0] || voices[0];
                lines.forEach(line => {
                    let u = new SpeechSynthesisUtterance(); u.lang = 'tr-TR';
                    if (line.toLowerCase().includes('sunucu') || line.toLowerCase().includes('host')) { u.voice = hostVoice; u.pitch = 1.1; u.text = line.replace(/^(Sunucu|Host)(\s*:\s*)/i, ''); } 
                    else if (line.toLowerCase().includes('uzman') || line.toLowerCase().includes('expert')) { u.voice = expertVoice; u.pitch = 0.9; u.text = line.replace(/^(Uzman|Expert)(\s*:\s*)/i, ''); } 
                    else { u.text = line; }
                    if(u.text.trim().length > 1) window.speechSynthesis.speak(u);
                });
            } else { alert("Ses desteklenmiyor."); }
        };

        // Quiz Logic
        window.generateQuiz = async (t) => {
            const doc = state.lastQuizDoc; if(!doc) return;
            const qCount = Math.max(5, (doc.pages ? doc.pages.length : 1) * 2);
            const l = addLoader(`${qCount} soru hazƒ±rlanƒ±yor...`);
            const res = await callGemini(`Create ${qCount} multiple choice questions about "${t}" based on text. **Questions in same language as text.** JSON format: [{"question": "...", "options": ["A", "B", "C", "D"], "correctIndex": 0}]. Text: ${doc.fullText.substring(0,50000)}`);
            removeLoader(l);
            if(res) {
                try {
                    const match = res.match(/\[[\s\S]*\]/); 
                    if(match) {
                        const questions = JSON.parse(match[0]);
                        questions.forEach(q => { state.quizHistory.push({ data: q, topic: t }); });
                        state.currentQuizIndex = state.quizHistory.length - questions.length;
                        window.displayQuiz(state.currentQuizIndex);
                    }
                } catch(e) { addMessage("Soru format hatasƒ±.", 'bot'); }
            }
        };

        window.displayQuiz = function(index) {
             const entry = state.quizHistory[index]; if (!entry) return; const q = entry.data; 
             const nav = state.quizHistory.length > 1 ? `<div class="flex gap-2"><button onclick="window.changeQuizView(-1)" class="bg-slate-700 px-2 rounded text-xs"><i class="fa-solid fa-chevron-left"></i></button><span class="text-xs text-slate-400">${index+1}/${state.quizHistory.length}</span><button onclick="window.changeQuizView(1)" class="bg-slate-700 px-2 rounded text-xs"><i class="fa-solid fa-chevron-right"></i></button></div>` : '';
             let html = `<div class="bg-slate-800 p-4 rounded border border-yellow-500/30 mt-2"><div class="flex justify-between items-center mb-3"><span class="text-yellow-300 text-xs font-bold uppercase">Quiz: ${entry.topic}</span>${nav}</div><p class="text-white font-semibold mb-4 text-sm">${q.question}</p><div class="space-y-2">`;
             q.options.forEach((o,i) => html+=`<button onclick="window.checkAns(this, ${i==q.correctIndex})" data-is-correct="${i==q.correctIndex}" class="w-full text-left p-2 rounded border border-slate-600 text-xs mb-1 hover:bg-slate-700">${String.fromCharCode(65+i)}) ${o}</button>`);
             html+=`</div></div>`; addMessage(html, 'bot', true);
        };
        window.changeQuizView = function(delta) { const newIndex = state.currentQuizIndex + delta; if (newIndex >= 0 && newIndex < state.quizHistory.length) { state.currentQuizIndex = newIndex; window.displayQuiz(newIndex); } };
        window.checkAns = (btn, isCor) => { const container = btn.parentElement; container.querySelectorAll('button').forEach(b => { b.disabled = true; if(b.getAttribute('data-is-correct') === 'true') { b.classList.add('bg-emerald-900/50', 'border-emerald-500', 'text-emerald-200'); } }); if(!isCor) { btn.classList.add('bg-red-900/50', 'border-red-500', 'text-red-200'); } };

        // Analyze helpers
        async function analyzeTopics(id, type) {
            const doc = state.documents.find(d=>d.id===id); if(!doc) return; 
            if(type === 'quiz') state.lastQuizDoc = doc; else state.lastFlashcardDoc = doc;
            const l = addLoader("Konular...");
            const res = await callGemini(`Analyze text and identify 4-5 topics JSON array. **Output in same language as text.** Text: ${doc.fullText.substring(0,5000)}`);
            removeLoader(l);
            if(res) {
                try {
                    const topics = JSON.parse(res.replace(/```json|```/g,'').trim());
                    let html = `<div class="bg-slate-800/80 p-3 rounded border border-slate-500/30 mt-2"><div class="text-slate-300 text-xs font-bold mb-2">Konu Se√ß</div><div class="grid gap-2">`;
                    topics.forEach(t => html+=`<button onclick="window.${type === 'quiz' ? 'generateQuiz' : 'generateFlashcards'}('${encodeURIComponent(t)}')" class="text-left text-xs text-slate-300 hover:text-white bg-slate-700 p-2 rounded">${t}</button>`);
                    addMessage(html+'</div></div>', 'bot', true);
                } catch(e){}
            }
        }

        // Kart Logic
        window.generateFlashcards = async (t) => {
            const topic = decodeURIComponent(t);
            const pageCount = state.lastFlashcardDoc.pages ? state.lastFlashcardDoc.pages.length : 1;
            const cCount = Math.max(5, pageCount * 2);
            const l = addLoader(`${cCount} kart hazƒ±rlanƒ±yor...`);
            const res = await callGemini(`Create ${cCount} flashcards about "${topic}" based strictly on text. JSON: [{"front":"Q","back":"A"}]. Text: ${state.lastFlashcardDoc.fullText.substring(0,50000)}`);
            removeLoader(l);
            if(res) { try { const cards = JSON.parse(res.replace(/```json|```/g,'').trim()); state.flashcardHistory.push({topic: topic, data: cards}); state.currentFlashcardSetIndex = state.flashcardHistory.length - 1; state.currentCardIndex = 0; document.getElementById('flashcard-overlay').classList.remove('hidden'); updateCardUI(); } catch(e){} }
        };
        function updateCardUI() { 
            const set = state.flashcardHistory[state.currentFlashcardSetIndex]; if (!set) return; 
            const card = set.data[state.currentCardIndex]; 
            document.getElementById('fc-front').textContent = card.front; document.getElementById('fc-back').textContent = card.back; 
            document.getElementById('fc-counter').textContent = `${state.currentCardIndex + 1} / ${set.data.length}`; 
            document.getElementById('flashcard-inner').classList.remove('flipped'); document.getElementById('flashcard-topic-title').textContent = `Konu: ${set.topic}`;
        }
        document.getElementById('prev-fc').onclick = () => { if(state.currentCardIndex > 0) { state.currentCardIndex--; updateCardUI(); }};
        document.getElementById('next-fc').onclick = () => { if(state.currentCardIndex < state.flashcardHistory[state.currentFlashcardSetIndex].data.length - 1) { state.currentCardIndex++; updateCardUI(); }};

        // Mobile Doc Selector
        function showMobileDocSelector(cbName) {
            if(state.documents.length===0) return addMessage("L√ºtfen √∂nce dosya y√ºkleyin.",'bot');
            if(state.documents.length===1) { if(cbName==='analyzeQuizTopics') analyzeTopics(state.documents[0].id, 'quiz'); else if(cbName==='analyzeFlashcardTopics') analyzeTopics(state.documents[0].id, 'flashcard'); else window[cbName](state.documents[0].id); return; }
            let html = `<div class="flex flex-col gap-2 bg-slate-800 p-2 rounded">`;
            state.documents.forEach(d => {
                let func = `window.${cbName}('${d.id}')`;
                if(cbName === 'analyzeQuizTopics') func = `window.analyzeTopics('${d.id}', 'quiz')`;
                if(cbName === 'analyzeFlashcardTopics') func = `window.analyzeTopics('${d.id}', 'flashcard')`;
                html+=`<button onclick="${func}" class="bg-slate-700 p-2 rounded text-left text-xs text-white border border-slate-600">${safeStr(d.name)}</button>`
            });
            addMessage(html+'</div>', 'bot', true);
        }

        // Button Assignments
        window.analyzeTopics = analyzeTopics; // Make global
        document.getElementById('diagram-btn').onclick = () => showMobileDocSelector('generateDiagram');
        document.getElementById('podcast-btn').onclick = () => showMobileDocSelector('generatePodcast');
        document.getElementById('start-quiz-btn').onclick = () => showMobileDocSelector('analyzeQuizTopics');
        document.getElementById('prepare-cards-btn').onclick = () => showMobileDocSelector('analyzeFlashcardTopics');
        document.getElementById('close-flashcards-btn').onclick = () => document.getElementById('flashcard-overlay').classList.add('hidden');

        // File & Chat
        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for(let i=0; i<files.length; i++) {
                const f = files[i]; const id='d-'+Date.now()+i;
                let txt = "ƒ∞√ßerik..."; let pages = [];
                // PDF Logic (Simplified)
                if(f.name.endsWith('.pdf')) {
                    try {
                        const buffer = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data: new Uint8Array(buffer)}).promise;
                        txt = "";
                        for(let j=1; j<=Math.min(pdf.numPages, 20); j++) { const p = await pdf.getPage(j); const c = await p.getTextContent(); const t = c.items.map(s=>s.str).join(' '); txt+=t+" "; pages.push({number:j, text:t}); }
                    } catch(e) { console.error(e); txt="Okuma hatasƒ±"; }
                } else { txt = await f.text(); }
                
                state.documents.push({id:id, name:f.name, fullText: txt, pages: pages});
                const li = document.createElement('li'); li.className="text-xs text-white bg-slate-700 p-1 rounded mb-1 truncate"; li.textContent = f.name;
                document.getElementById('file-list').appendChild(li);
                addMessage(`üìÑ ${f.name} y√ºklendi.`, 'bot');
            }
        });

        document.getElementById('send-btn').onclick = async () => {
            const q = userInput.value.trim(); if(!q) return;
            addMessage(q, 'user'); userInput.value='';
            // Context building
            let context = state.documents.map(d => `Dok√ºman: ${d.name}\n${d.fullText.substring(0,5000)}`).join("\n\n");
            const res = await callGemini(`Sen DEHA'sƒ±n. Cevapla:\n${context}\nSoru: ${q}`);
            if(res) addMessage(res.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'), 'bot', true);
        };
        
        // Load Key
        const k = localStorage.getItem('deha_api_key'); if(k) document.getElementById('api-key-input').classList.add('hidden');
    });
    </script>
</body>
</html>
